<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start of Day Perek</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />


    <script src="js/settings.js"></script>
    <script src="js/mesechot-data.js"></script>
    <style>
        .section-title {
            font-size: 1.08em;
            background-color: #eae2e2;
            font-weight: 300;
            margin-bottom: 10px;
            cursor: default;
        }

        .bb.current-mesechet {
            font-size: 1.1em;
            font-weight: bolder;
            text-decoration: underline;
        }

        .perek-header-title {
            flex: 1;
            /* take up the remaining space between left & right */
            font-size: 18px;
            font-weight: bold;
            padding: 4px 0;
            text-align: center;
            /* center the text within that space */
        }
    </style>
    <script src="themes/theme.js"></script>
</head>

<body>
    <i class="fa-solid fa-arrow-left" id="openNav" onclick="location.href='settings.html'"></i>
    <h2 id="pereksTodayStartIndex"></h2>

    <div class="goal-display-container">
        <h2 id="goal"></h2>
    </div>
    <div class="edit-goal-container">
        <button id="editGoalBtn" style="z-index: 2" ;>Edit Goal</button>

        <div id="goalEditPanel" class="goal-edit-panel" style="
            display: none;
            margin-top: 10px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #ccc;
            position: relative;
            z-index: 3;
        ">
            <input type="number" id="goalInput" min="1" placeholder="Perekim per day"
                style="padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; max-width: 120px;" />
            <button id="saveGoalBtn"
                style="padding: 6px 10px; border-radius: 6px; border: none; background: #4caf50; color: white; cursor: pointer;">
                Save
            </button>
            <button id="cancelGoalBtn" type="button"
                style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>


    <div class="space"></div>

    <div class="container ">

        <div class="sidebar ">
            <div class="bb-container ">
                <ul class="menu ">
                    <li class="menu-item ">
                        <p id="bold">mesachet</p>
                        <ul class="submenu" id="mesechetList">
                            <!-- will be filled by JS -->
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pereksTodayStartIndexDisplay = document.getElementById('pereksTodayStartIndex');
            const goalContainer = document.querySelector('.goal-display-container');
            const goalEl = document.getElementById('goal');
            const mesechetList = document.getElementById('mesechetList');
            const sidebar = document.querySelector('.sidebar');

            if (!mesechetList || typeof mesechotData === 'undefined' || !Array.isArray(mesechotData)) {
                console.error('mesechetList element or mesechotData is missing.');
                return;
            }

            // Only real masechtot for math (ignore section entries)
            const realMasechtot = mesechotData.filter(
                item => item.name && typeof item.pereks === 'number'
            );

            // Hebrew numerals for perakim
            const hebrewDigits = [
                'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י',
                'י"א', 'י"ב', 'י"ג', 'י"ד', 'ט"ו', 'ט"ז', 'י"ז', 'י"ח', 'י"ט',
                'כ', 'כ"א', 'כ"ב', 'כ"ג', 'כ"ד', 'כ"ה', 'כ"ו', 'כ"ז', 'כ"ח', 'כ"ט', 'ל'
            ];

            let isShowingPereks = false;

            // Use ONLY realMasechtot for index calculations
            function findMesechetAndPerekByIndex(index) {
                let cumulativePereks = 0;
                for (let i = 0; i < realMasechtot.length; i++) {
                    const pereksInMesechet = realMasechtot[i].pereks;
                    if (cumulativePereks + pereksInMesechet >= index) {
                        const perekNumber = index - cumulativePereks; // 1-based
                        const perekHebrew = hebrewDigits[perekNumber - 1] || 'Unknown';
                        return { mesechet: realMasechtot[i].name, perek: perekHebrew };
                    }
                    cumulativePereks += pereksInMesechet;
                }
                return { mesechet: 'Unknown', perek: 'Unknown' };
            }

            function updatePereksTodayStartIndexDisplay() {
                let pereksTodayStartIndex = parseInt(
                    localStorage.getItem('pereksTodayStartIndex') || '0',
                    10
                );
                const { mesechet, perek } = findMesechetAndPerekByIndex(pereksTodayStartIndex + 1);
                pereksTodayStartIndexDisplay.innerHTML = `Start of day  ${mesechet} פרק ${perek}`;
            }

            // Respect settings toggle
            let displayPerekGoal = localStorage.getItem('displayPerekGoal');
            const showGoal = (displayPerekGoal === null || displayPerekGoal === 'true');
            if (goalContainer) {
                goalContainer.style.display = showGoal ? 'block' : 'none';
            }

            // Global index calculation over realMasechtot
            function calculateGlobalPerekIndex(realMasechetIndex1Based, perekIndexZeroBased) {
                let globalPerekIndex = 0;
                for (let i = 0; i < realMasechetIndex1Based - 1; i++) {
                    globalPerekIndex += realMasechtot[i].pereks;
                }
                // zero based like your old code
                globalPerekIndex += perekIndexZeroBased;
                return globalPerekIndex;
            }

            // Render mesechet list with section headers
            function renderMesechetList() {
                isShowingPereks = false;
                mesechetList.innerHTML = '';

                let realIndex = 0; // index into realMasechtot

                mesechotData.forEach((item) => {
                    // Section row

                    if (item.section) {
                        const li = document.createElement("li");
                        li.classList.add("section-title");
                        const label = document.createElement("span");
                        label.textContent = item.section;
                        li.appendChild(label);
                        mesechetList.appendChild(li);
                        return;
                    }
                    // Real masechet
                    const li = document.createElement('li');
                    const p = document.createElement('p');

                    p.classList.add('bb', `bb${item.pereks}`);
                    p.textContent = item.name;
                    p.style.cursor = 'pointer';

                    // Store its index within the realMasechtot array (1-based)
                    const realIndex1Based = realIndex + 1;
                    p.dataset.realIndex = String(realIndex1Based);

                    p.addEventListener('click', (e) => {
                        e.stopPropagation();
                        renderPerekList(realIndex1Based);
                    });

                    li.appendChild(p);
                    mesechetList.appendChild(li);

                    realIndex++;
                });
            }

            // Render perek list for a given realMasechet index (1-based)
            function renderPerekList(realMasechetIndex1Based) {
                isShowingPereks = true;
                const mesechet = realMasechtot[realMasechetIndex1Based - 1];
                mesechetList.innerHTML = '';

                // Header with X button
                const headerLi = document.createElement('li');
                headerLi.classList.add('perek-header');

                const headerWrapper = document.createElement('div');
                headerWrapper.style.display = 'flex';
                headerWrapper.style.justifyContent = 'space-between';
                headerWrapper.style.alignItems = 'center';

                const titleSpan = document.createElement('span');
                titleSpan.textContent = mesechet.name;
                titleSpan.className = 'perek-header-title';

                const closeBtn = document.createElement("i");
                closeBtn.className = "fa-solid fa-x perek-close-button";
                closeBtn.style.cursor = "pointer";
                closeBtn.style.fontSize = "1.2rem";
                closeBtn.style.padding = "4px";   // optional for easier tapping


                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    renderMesechetList();
                });

                headerWrapper.appendChild(titleSpan);
                headerWrapper.appendChild(closeBtn);
                headerLi.appendChild(headerWrapper);
                mesechetList.appendChild(headerLi);

                // Perek items
                for (let i = 0; i < mesechet.pereks; i++) {
                    const li = document.createElement('li');
                    const p = document.createElement('p');
                    p.style.cursor = 'pointer';

                    const perekHebrewNumber = hebrewDigits[i];
                    p.textContent = `${mesechet.name} פרק ${perekHebrewNumber}`;

                    p.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const globalPerekIndex = calculateGlobalPerekIndex(
                            realMasechetIndex1Based,
                            i + 0
                        );
                        let pereksTodayStartIndex = globalPerekIndex;
                        localStorage.setItem(
                            'pereksTodayStartIndex',
                            pereksTodayStartIndex.toString()
                        );
                        updatePereksTodayStartIndexDisplay();

                        if (goalAPI && goalAPI.updateGoalDisplay) {
                            goalAPI.updateGoalDisplay();
                        }

                        renderMesechetList();
                    });

                    li.appendChild(p);
                    mesechetList.appendChild(li);
                }
            }

            // Shared goal controls
            const goalAPI = initPerekGoalControls({
                goalElId: 'goal',
                editBtnId: 'editGoalBtn',
                panelId: 'goalEditPanel',
                inputId: 'goalInput',
                saveBtnId: 'saveGoalBtn',
                cancelBtnId: 'cancelGoalBtn',
                deferInitialRender: true,
                renderGoal: (goalEl, perekGoal) => {
                    if (!showGoal) {
                        goalEl.textContent = '';
                        return;
                    }

                    let pereksTodayStartIndex = parseInt(
                        localStorage.getItem('pereksTodayStartIndex') || '0',
                        10
                    );
                    if (isNaN(pereksTodayStartIndex)) pereksTodayStartIndex = 0;

                    const goalIndex = pereksTodayStartIndex + perekGoal;
                    const { mesechet, perek } = findMesechetAndPerekByIndex(goalIndex + 1);

                    goalEl.innerHTML = `Goal + ${perekGoal}  ${mesechet} פרק ${perek}`;
                }
            });

            // Daily reset of pereksTodayStartIndex
            let pereksTodayStartIndex = parseInt(
                localStorage.getItem('pereksTodayStartIndex') || '0',
                10
            );
            let lastDate = localStorage.getItem('lastDate') || '';
            let todayDate = new Date().toDateString();

            if (lastDate !== todayDate) {
                lastDate = todayDate;
                localStorage.setItem('lastDate', todayDate);
                pereksTodayStartIndex = 0;
                localStorage.setItem('pereksTodayStartIndex', pereksTodayStartIndex.toString());
            }

            // Click outside sidebar to go back to mesechet list when in perek view
            document.addEventListener('click', function (event) {
                if (isShowingPereks && sidebar && !sidebar.contains(event.target)) {
                    renderMesechetList();
                }
            });

            // Initial render
            renderMesechetList();
            updatePereksTodayStartIndexDisplay();

            if (goalAPI && goalAPI.updateGoalDisplay) {
                goalAPI.updateGoalDisplay();
            }
        });
    </script>


</body>

</html>