<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start of Day Perek</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="themes/theme.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/mesechot-data.js"></script>
</head>

<body>
    <i class="fa-solid fa-arrow-left" id="openNav" onclick="location.href='settings.html'"></i>
    <h2 id="pereksTodayStartIndex"></h2>

    <div class="goal-display-container">
        <h2 id="goal"></h2>
    </div>
    <div class="edit-goal-container">
        <button id="editGoalBtn" style="z-index: 2" ;>Edit Goal</button>

        <div id="goalEditPanel" class="goal-edit-panel" style="
            display: none;
            margin-top: 10px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #ccc;
            position: relative;
            z-index: 3;
        ">
            <input type="number" id="goalInput" min="1" placeholder="Perekim per day"
                style="padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; max-width: 120px;" />
            <button id="saveGoalBtn"
                style="padding: 6px 10px; border-radius: 6px; border: none; background: #4caf50; color: white; cursor: pointer;">
                Save
            </button>
            <button id="cancelGoalBtn" type="button"
                style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>


    <div class="space"></div>

    <div class="container ">

        <div class="sidebar ">
            <div class="bb-container ">
                <ul class="menu ">
                    <li class="menu-item ">
                        <p id="bold">mesachet</p>
                        <ul class="submenu" id="mesechetList">
                            <!-- will be filled by JS -->
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pereksTodayStartIndexDisplay = document.getElementById('pereksTodayStartIndex');
            const goalContainer = document.querySelector('.goal-display-container');
            const goalEl = document.getElementById('goal');
            const mesechetList = document.getElementById('mesechetList');
            const sidebar = document.querySelector('.sidebar');

            // Safety check to avoid silent crash
            if (!mesechetList || typeof mesechotData === 'undefined' || !Array.isArray(mesechotData)) {
                console.error('mesechetList element or mesechotData is missing.');
                return;
            }

            // Hebrew numerals for perakim
            const hebrewDigits = [
                'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י',
                'י"א', 'י"ב', 'י"ג', 'י"ד', 'ט"ו', 'ט"ז', 'י"ז', 'י"ח', 'י"ט',
                'כ', 'כ"א', 'כ"ב', 'כ"ג', 'כ"ד', 'כ"ה', 'כ"ו', 'כ"ז', 'כ"ח', 'כ"ט', 'ל'
            ];

            let isShowingPereks = false;

            // Use data instead of DOM for index calculations
            function findMesechetAndPerekByIndex(index) {
                let cumulativePereks = 0;
                for (let i = 0; i < mesechotData.length; i++) {
                    const pereksInMesechet = mesechotData[i].pereks;
                    if (cumulativePereks + pereksInMesechet >= index) {
                        const perekNumber = index - cumulativePereks; // 1-based
                        const perekHebrew = hebrewDigits[perekNumber - 1] || 'Unknown';
                        return { mesechet: mesechotData[i].name, perek: perekHebrew };
                    }
                    cumulativePereks += pereksInMesechet;
                }
                return { mesechet: 'Unknown', perek: 'Unknown' };
            }

            function updatePereksTodayStartIndexDisplay() {
                let pereksTodayStartIndex = parseInt(localStorage.getItem('pereksTodayStartIndex') || '0', 10);
                const { mesechet, perek } = findMesechetAndPerekByIndex(pereksTodayStartIndex + 1);
                pereksTodayStartIndexDisplay.innerHTML = `Start of day  ${mesechet} פרק ${perek}`;
            }

            // Respect settings toggle
            let displayPerekGoal = localStorage.getItem('displayPerekGoal');
            const showGoal = (displayPerekGoal === null || displayPerekGoal === 'true');
            if (goalContainer) {
                goalContainer.style.display = showGoal ? 'block' : 'none';
            }

            // Global index calculation (keeping your style)
            function calculateGlobalPerekIndex(mesechetIndex, perekIndexZeroBased) {
                let globalPerekIndex = 0;
                for (let i = 0; i < mesechetIndex - 1; i++) {
                    globalPerekIndex += mesechotData[i].pereks;
                }
                globalPerekIndex += perekIndexZeroBased; // 0-based like your old code
                return globalPerekIndex;
            }

            // Render the mesechet list (default view)
            function renderMesechetList() {
                isShowingPereks = false;
                mesechetList.innerHTML = '';

                mesechotData.forEach((item, index) => {
                    const li = document.createElement('li');
                    const p = document.createElement('p');

                    // Keep bb + bb{pereks}
                    p.classList.add('bb', `bb${item.pereks}`);
                    p.textContent = item.name;
                    p.style.cursor = 'pointer';

                    p.addEventListener('click', (e) => {
                        e.stopPropagation(); // avoid global click handlers interfering
                        // console.log('Mesechet clicked:', item.name);
                        renderPerekList(index + 1); // mesechetIndex is 1-based
                    });

                    li.appendChild(p);
                    mesechetList.appendChild(li);
                });
            }

            // Render the perek list for a given mesechet
            function renderPerekList(mesechetIndex) {
                isShowingPereks = true;
                const mesechet = mesechotData[mesechetIndex - 1];
                mesechetList.innerHTML = '';

                // Header with X button
                const headerLi = document.createElement('li');
                headerLi.classList.add('perek-header');

                const headerWrapper = document.createElement('div');
                headerWrapper.style.display = 'flex';
                headerWrapper.style.justifyContent = 'space-between';
                headerWrapper.style.alignItems = 'center';

                const titleSpan = document.createElement('span');
                titleSpan.textContent = mesechet.name;
                titleSpan.className = 'perek-header-title';
                const closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.textContent = '×';
                closeBtn.style.border = 'none';
                closeBtn.style.background = 'transparent';
                closeBtn.style.fontSize = '1.2rem';
                closeBtn.style.cursor = 'pointer';

                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    renderMesechetList();
                });

                headerWrapper.appendChild(titleSpan);
                headerWrapper.appendChild(closeBtn);
                headerLi.appendChild(headerWrapper);
                mesechetList.appendChild(headerLi);

                // Perek items
                for (let i = 0; i < mesechet.pereks; i++) {
                    const li = document.createElement('li');
                    const p = document.createElement('p');
                    p.style.cursor = 'pointer';

                    const perekHebrewNumber = hebrewDigits[i];
                    p.textContent = `${mesechet.name} פרק ${perekHebrewNumber}`;

                    p.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const globalPerekIndex = calculateGlobalPerekIndex(mesechetIndex, i + 0);
                        let pereksTodayStartIndex = globalPerekIndex;
                        localStorage.setItem('pereksTodayStartIndex', pereksTodayStartIndex.toString());
                        updatePereksTodayStartIndexDisplay();

                        if (goalAPI && goalAPI.updateGoalDisplay) {
                            goalAPI.updateGoalDisplay();
                        }

                        // After choosing a perek, return to mesechet list
                        renderMesechetList();
                    });

                    li.appendChild(p);
                    mesechetList.appendChild(li);
                }
            }

            // Use shared helper to wire Edit Goal + Save/Cancel
            const goalAPI = initPerekGoalControls({
                goalElId: 'goal',
                editBtnId: 'editGoalBtn',
                panelId: 'goalEditPanel',
                inputId: 'goalInput',
                saveBtnId: 'saveGoalBtn',
                cancelBtnId: 'cancelGoalBtn',
                deferInitialRender: true,
                renderGoal: (goalEl, perekGoal) => {
                    // If user turned off goal display in settings, don't draw text,
                    // but DO NOT touch the edit UI or goalContainer here.
                    if (!showGoal) {
                        goalEl.textContent = '';
                        return;
                    }

                    let pereksTodayStartIndex = parseInt(
                        localStorage.getItem('pereksTodayStartIndex') || '0',
                        10
                    );
                    if (isNaN(pereksTodayStartIndex)) pereksTodayStartIndex = 0;

                    // your original style preserved
                    const goalIndex = pereksTodayStartIndex + perekGoal - 0;
                    const { mesechet, perek } = findMesechetAndPerekByIndex(goalIndex + 1);

                    goalEl.innerHTML = `Goal + ${perekGoal + 0}  ${mesechet} פרק ${perek}`;
                }
            });





            // Daily reset of pereksTodayStartIndex
            let pereksTodayStartIndex = parseInt(localStorage.getItem('pereksTodayStartIndex') || '0', 10);
            let lastDate = localStorage.getItem('lastDate') || '';
            let todayDate = new Date().toDateString();

            if (lastDate !== todayDate) {
                lastDate = todayDate;
                localStorage.setItem('lastDate', todayDate);
                pereksTodayStartIndex = 0;
                localStorage.setItem('pereksTodayStartIndex', pereksTodayStartIndex.toString());
            }

            // Click-outside handler: if in perek view and user clicks outside sidebar, go back to mesechet list
            document.addEventListener('click', function (event) {
                if (isShowingPereks && sidebar && !sidebar.contains(event.target)) {
                    renderMesechetList();
                }
            });


            // Initial render
            renderMesechetList();
            updatePereksTodayStartIndexDisplay();

            if (goalAPI && goalAPI.updateGoalDisplay) {
                goalAPI.updateGoalDisplay();
            }
        });
    </script>


</body>

</html>